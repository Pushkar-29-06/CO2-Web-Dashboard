{% extends "base.html" %}

{% block title %}Compare Cities - CO2 Emissions Dashboard{% endblock %}

{% block main_content %}
<div class="container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6">Compare Cities</h1>

  <!-- City Selection Form -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-semibold mb-4">Select Cities to Compare</h2>
    <form method="GET" action="{{ url_for('main.compare') }}" class="flex flex-wrap gap-4 items-end">
      <div class="flex-1 min-w-48">
        <label for="city1" class="block text-sm font-medium text-gray-700 mb-1">First City</label>
        <select name="city1" id="city1" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="">Select a city</option>
          {% for city in available_cities %}
          <option value="{{ city }}" {% if city == city1 %}selected{% endif %}>{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex-1 min-w-48">
        <label for="city2" class="block text-sm font-medium text-gray-700 mb-1">Second City</label>
        <select name="city2" id="city2" class="w-full p-2 border border-gray-300 rounded-md" required>
          <option value="">Select a city</option>
          {% for city in available_cities %}
          <option value="{{ city }}" {% if city == city2 %}selected{% endif %}>{{ city }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-colors">
          Compare Cities
        </button>
      </div>
    </form>
  </div>

  {% if not city1_data or not city2_data %}
  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
    <p class="font-bold">No Cities Selected</p>
    <p>Please select two cities above to compare their emissions and air quality data.</p>
  </div>
  {% else %}
  <!-- City Comparison Summary -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- City 1 Card -->
    <div class="bg-white rounded-lg shadow-md p-6" id="city1_data"
         data-name="{{ city1_data.City }}"
         data-co2="{{ city1_data['CO2_Emissions_kt']|default(0) }}"
         data-aqi="{{ city1_data['AQI']|default(0) }}"
         data-so2="{{ city1_data['SO2_ppb']|default(0) }}"
         data-no2="{{ city1_data['NO2_ppb']|default(0) }}"
         data-pm25="{{ city1_data['PM2.5_ug/m3']|default(0) }}"
         data-pm10="{{ city1_data['PM10_ug/m3']|default(0) }}"
         data-population="{{ city1_data['Population']|default(0) }}"
         data-vehicles="{{ city1_data['Vehicle_Density']|default(0) }}"
         data-industry="{{ city1_data['Industrial_Activity_Score']|default(0) }}"
         data-forest="{{ city1_data['Forest_Cover_pct']|default(0) }}">
      <h2 class="text-2xl font-bold mb-4">{{ city1_data.City }}</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-gray-600">CO₂ Emissions</p>
          <p class="text-xl font-semibold">{{ "%.2f"|format(city1_data['CO2_Emissions_kt']|float) }} kt</p>
        </div>
        <div>
          <p class="text-gray-600">Air Quality (AQI)</p>
          <p class="text-xl font-semibold">{{ city1_data['AQI']|default('N/A') }}</p>
        </div>
      </div>
    </div>

    <!-- City 2 Card -->
    <div class="bg-white rounded-lg shadow-md p-6" id="city2_data"
         data-name="{{ city2_data.City }}"
         data-co2="{{ city2_data['CO2_Emissions_kt']|default(0) }}"
         data-aqi="{{ city2_data['AQI']|default(0) }}"
         data-so2="{{ city2_data['SO2_ppb']|default(0) }}"
         data-no2="{{ city2_data['NO2_ppb']|default(0) }}"
         data-pm25="{{ city2_data['PM2.5_ug/m3']|default(0) }}"
         data-pm10="{{ city2_data['PM10_ug/m3']|default(0) }}"
         data-population="{{ city2_data['Population']|default(0) }}"
         data-vehicles="{{ city2_data['Vehicle_Density']|default(0) }}"
         data-industry="{{ city2_data['Industrial_Activity_Score']|default(0) }}"
         data-forest="{{ city2_data['Forest_Cover_pct']|default(0) }}">
      <h2 class="text-2xl font-bold mb-4">{{ city2_data.City }}</h2>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <p class="text-gray-600">CO₂ Emissions</p>
          <p class="text-xl font-semibold">{{ "%.2f"|format(city2_data['CO2_Emissions_kt']|float) }} kt</p>
        </div>
        <div>
          <p class="text-gray-600">Air Quality (AQI)</p>
          <p class="text-xl font-semibold">{{ city2_data['AQI']|default('N/A') }}</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Charts Section - Always visible -->
  <div class="space-y-8">
    {% if not city1_data or not city2_data %}
    <div class="bg-gray-100 border border-gray-300 text-gray-700 p-8 text-center rounded-lg">
      <h3 class="text-lg font-semibold mb-2">Charts will appear here</h3>
      <p>Please select two cities above to view their comparison charts.</p>
    </div>
    {% else %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">CO₂ Emissions (kt)</h2>
        <div class="chart-container">
          {% if visualizations.co2_emissions %}
          <img src="{{ visualizations.co2_emissions }}" alt="CO₂ Emissions Comparison" class="w-full h-auto rounded">
          {% else %}
          <div id="emissionChart" style="width: 100%; height: 100%; min-height: 300px;"></div>
          {% endif %}
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Air Quality Index (AQI)</h2>
        <div class="chart-container">
          {% if visualizations.aqi_comparison %}
          <img src="{{ visualizations.aqi_comparison }}" alt="AQI Comparison" class="w-full h-auto rounded">
          {% else %}
          <div id="aqiChart" style="width: 100%; height: 100%; min-height: 300px;"></div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Pollutants Comparison</h2>
        <div class="chart-container">
          {% if visualizations.pollutants_comparison %}
          <img src="{{ visualizations.pollutants_comparison }}" alt="Pollutants Comparison" class="w-full h-auto rounded">
          {% else %}
          <div id="pollutantsChart" style="width: 100%; height: 100%; min-height: 300px;"></div>
          {% endif %}
        </div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Environmental Factors</h2>
        <div class="chart-container">
          {% if visualizations.environmental_comparison %}
          <img src="{{ visualizations.environmental_comparison }}" alt="Environmental Factors Comparison" class="w-full h-auto rounded">
          {% else %}
          <div id="environmentChart" style="width: 100%; height: 100%; min-height: 300px;"></div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4">Overall Comparison</h2>
      <div class="chart-container">
        {% if visualizations.radar_comparison %}
        <img src="{{ visualizations.radar_comparison }}" alt="Overall Comparison" class="w-full h-auto rounded">
        {% else %}
        <div id="radarChart" style="width: 100%; height: 100%; min-height: 400px;"></div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Initialize all charts using Plotly.js
function initCharts() {
    try {
        console.log('initCharts called with Plotly.js');

        // Get city data from DOM elements
        const city1Data = document.getElementById('city1_data');
        const city2Data = document.getElementById('city2_data');

        if (!city1Data || !city2Data) {
            console.log('City data elements not found - no cities selected yet');
            return;
        }

        // Parse city data
        const city1 = {
            name: city1Data.dataset.name,
            co2: parseFloat(city1Data.dataset.co2) || 0,
            aqi: parseFloat(city1Data.dataset.aqi) || 0,
            so2: parseFloat(city1Data.dataset.so2) || 0,
            no2: parseFloat(city1Data.dataset.no2) || 0,
            pm25: parseFloat(city1Data.dataset.pm25) || 0,
            pm10: parseFloat(city1Data.dataset.pm10) || 0,
            population: parseInt(city1Data.dataset.population) || 0,
            vehicles: parseFloat(city1Data.dataset.vehicles) || 0,
            industry: parseFloat(city1Data.dataset.industry) || 0,
            forest: parseFloat(city1Data.dataset.forest) || 0
        };

        const city2 = {
            name: city2Data.dataset.name,
            co2: parseFloat(city2Data.dataset.co2) || 0,
            aqi: parseFloat(city2Data.dataset.aqi) || 0,
            so2: parseFloat(city2Data.dataset.so2) || 0,
            no2: parseFloat(city2Data.dataset.no2) || 0,
            pm25: parseFloat(city2Data.dataset.pm25) || 0,
            pm10: parseFloat(city2Data.dataset.pm10) || 0,
            population: parseInt(city2Data.dataset.population) || 0,
            vehicles: parseFloat(city2Data.dataset.vehicles) || 0,
            industry: parseFloat(city2Data.dataset.industry) || 0,
            forest: parseFloat(city2Data.dataset.forest) || 0
        };

        console.log('City 1 data:', city1);
        console.log('City 2 data:', city2);

        // Create CO2 Emissions Chart
        const emissionData = [{
            x: [city1.name, city2.name],
            y: [city1.co2, city2.co2],
            type: 'bar',
            name: 'CO₂ Emissions',
            marker: {
                color: ['#36A2EB', '#FF6384']
            }
        }];

        const emissionLayout = {
            title: 'CO₂ Emissions (kt)',
            yaxis: { title: 'CO₂ Emissions (kt)' },
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };

        Plotly.newPlot('emissionChart', emissionData, emissionLayout, { responsive: true });

        // Create AQI Chart
        const aqiData = [{
            x: [city1.name, city2.name],
            y: [city1.aqi, city2.aqi],
            type: 'bar',
            name: 'Air Quality Index',
            marker: {
                color: ['#36A2EB', '#FF6384']
            }
        }];

        const aqiLayout = {
            title: 'Air Quality Index (AQI)',
            yaxis: { title: 'AQI' },
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };

        Plotly.newPlot('aqiChart', aqiData, aqiLayout, { responsive: true });

        // Create Pollutants Chart
        const pollutantsData = [{
            x: ['SO₂', 'NO₂', 'PM2.5', 'PM10'],
            y: [city1.so2, city1.no2, city1.pm25, city1.pm10],
            type: 'bar',
            name: city1.name,
            marker: { color: '#36A2EB' }
        }, {
            x: ['SO₂', 'NO₂', 'PM2.5', 'PM10'],
            y: [city2.so2, city2.no2, city2.pm25, city2.pm10],
            type: 'bar',
            name: city2.name,
            marker: { color: '#FF6384' }
        }];

        const pollutantsLayout = {
            title: 'Pollutants Comparison',
            barmode: 'group',
            yaxis: { title: 'Concentration' },
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };

        Plotly.newPlot('pollutantsChart', pollutantsData, pollutantsLayout, { responsive: true });

        // Create Environment Chart
        const environmentData = [{
            x: ['Population', 'Vehicle Density', 'Industry Score', 'Forest Cover %'],
            y: [city1.population, city1.vehicles, city1.industry, city1.forest],
            type: 'bar',
            name: city1.name,
            marker: { color: '#36A2EB' }
        }, {
            x: ['Population', 'Vehicle Density', 'Industry Score', 'Forest Cover %'],
            y: [city2.population, city2.vehicles, city2.industry, city2.forest],
            type: 'bar',
            name: city2.name,
            marker: { color: '#FF6384' }
        }];

        const environmentLayout = {
            title: 'Environmental Factors',
            barmode: 'group',
            yaxis: { title: 'Value' },
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };

        Plotly.newPlot('environmentChart', environmentData, environmentLayout, { responsive: true });

        // Create Radar Chart
        const radarData = [{
            type: 'scatterpolar',
            r: [
                city1.co2,
                city1.aqi,
                city1.so2,
                city1.no2,
                city1.pm25,
                city1.pm10,
                city1.population,
                city1.vehicles,
                city1.industry,
                city1.forest
            ],
            theta: ['CO₂ Emissions', 'Air Quality', 'SO₂', 'NO₂', 'PM2.5', 'PM10', 'Population', 'Vehicles', 'Industry', 'Forest'],
            fill: 'toself',
            name: city1.name,
            line: { color: '#36A2EB' }
        }, {
            type: 'scatterpolar',
            r: [
                city2.co2,
                city2.aqi,
                city2.so2,
                city2.no2,
                city2.pm25,
                city2.pm10,
                city2.population,
                city2.vehicles,
                city2.industry,
                city2.forest
            ],
            theta: ['CO₂ Emissions', 'Air Quality', 'SO₂', 'NO₂', 'PM2.5', 'PM10', 'Population', 'Vehicles', 'Industry', 'Forest'],
            fill: 'toself',
            name: city2.name,
            line: { color: '#FF6384' }
        }];

        const radarLayout = {
            title: 'Overall Comparison',
            polar: {
                radialaxis: {
                    visible: true,
                    range: [0, Math.max(
                        city1.co2, city1.aqi, city1.so2, city1.no2, city1.pm25, city1.pm10,
                        city1.population, city1.vehicles, city1.industry, city1.forest,
                        city2.co2, city2.aqi, city2.so2, city2.no2, city2.pm25, city2.pm10,
                        city2.population, city2.vehicles, city2.industry, city2.forest
                    ) * 1.1]
                }
            },
            showlegend: true,
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };

        Plotly.newPlot('radarChart', radarData, radarLayout, { responsive: true });

        console.log('All Plotly charts created successfully');

    } catch (error) {
        console.error('Error in initCharts:', error);
    }
}

// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded, checking for Plotly...');

    // Check if chart containers exist before initializing
    const chartElements = ['emissionChart', 'aqiChart', 'pollutantsChart', 'environmentChart', 'radarChart'];
    const chartsExist = chartElements.some(id => document.getElementById(id) !== null);

    if (!chartsExist) {
        console.log('No chart elements found - cities not selected yet');
        return;
    }

    // Check if Plotly is available
    if (typeof Plotly === 'undefined') {
        console.log('Plotly not loaded yet, waiting...');
        // Wait for Plotly to load
        let checkCount = 0;
        const checkPlotly = setInterval(() => {
            checkCount++;
            if (typeof Plotly !== 'undefined') {
                clearInterval(checkPlotly);
                console.log('Plotly loaded, initializing charts...');
                initCharts();
            } else if (checkCount > 50) { // 5 seconds timeout
                clearInterval(checkPlotly);
                console.error('Plotly failed to load within timeout');
            }
        }, 100);
    } else {
        console.log('Plotly available, initializing charts...');
        initCharts();
    }
});
</script>
{% endblock %}
